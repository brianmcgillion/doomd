# Doom Emacs Configuration - Copilot Instructions

This is **Brian McGillion's personal Doom Emacs configuration**, serving as the primary IDE, text editor, and knowledge management system.

## ⚠️ CRITICAL: This is a Literate Configuration

**ALL configuration changes MUST be made in `config.org`, NOT `config.el`.**

- `config.org` is the source of truth (org-mode with embedded elisp)
- `config.el` is auto-generated by tangling `config.org`
- Doom's `:config literate` module handles the tangling on `doom sync`
- Direct edits to `config.el` will be **overwritten**

## Project Overview

- **Type**: Personal Doom Emacs configuration (LITERATE)
- **Location**: `~/.config/doom/` (this directory)
- **Doom Core**: `~/.config/emacs/`
- **Owner**: Brian McGillion (brian@ssrc.tii.ae)
- **Primary Uses**:
  - Org-mode for personal knowledge management (Zettelkasten via org-roam)
  - Software development IDE (multiple languages with LSP + tree-sitter)
  - RSS reader (elfeed with scoring)
  - AI-assisted coding (GitHub Copilot CLI external, copilot.el for inline completions)

## File Organization

| File | Purpose | Editing Rules |
|------|---------|---------------|
| `config.org` | **Literate configuration source** | **✅ EDIT THIS FILE** for all customizations |
| `config.el` | Auto-generated from config.org | **❌ NEVER EDIT** - will be overwritten |
| `init.el` | Doom module selection via `doom!` macro | Only enable/disable modules here |
| `packages.el` | Package declarations via `package!` | Only declare packages, no configuration |
| `elfeed-config.el` | RSS feed and elfeed scoring config | Loaded by config.el |
| `custom.el` | Emacs Customize settings | Auto-managed, avoid manual edits |
| `banner/` | Custom splash screen images | PNG images for dashboard |

## Doom Emacs Conventions

### Required Macros (NOT vanilla Emacs)

```elisp
;; ✅ CORRECT - Use Doom macros where still applicable
(setq! variable value)           ; NOT setq
(with-eval-after-load 'pkg ...)  ; NOT after! (deprecated)
(use-package name ...)           ; NOT use-package! (deprecated)
(map! :leader ...)               ; NOT define-key
(package! name)                  ; In packages.el only
(doom! :module ...)              ; In init.el only

;; ❌ WRONG - Don't use these
(setq variable value)            ; May be overridden
(after! package-name ...)        ; Deprecated
(use-package! name ...)          ; Deprecated
(use-package name :ensure t)     ; ensure not needed in Doom
```

### `with-eval-after-load` Usage

Wrap package customization in `with-eval-after-load` blocks to ensure settings apply after the package loads:

```elisp
(with-eval-after-load 'org
  (setq! org-directory "~/Documents/org/"))

(with-eval-after-load 'lsp-mode
  (setq lsp-nix-server 'nixd))
```

### Important CLI Commands

```bash
doom sync      # After ANY config changes - installs packages, rebuilds
doom upgrade   # Update Doom and all packages
doom doctor    # Diagnose configuration issues
doom env       # Regenerate environment snapshot
doom build     # Recompile packages (after Emacs upgrade)
```

**Always run `doom sync` after modifying init.el, config.el, or packages.el.**

## Code Style Conventions

### Function Naming

Custom functions use the `bmg/` prefix:

```elisp
(defun bmg/switch-to-agenda ()
  "Switch to org-agenda overview view."
  (interactive)
  (org-agenda nil "o"))

(defun bmg/api-key-from-auth-source (&optional host user)
  "Lookup api key in the auth source."
  ...)
```

### Section Markers

Config sections are delimited with comment markers:

```elisp
;;;
;;;
;;; BEGIN_SectionName
;;;
;;;

;; ... section content ...

;;;
;;;
;;; END_SectionName
;;;
;;;
```

### File Headers

All Elisp files must have lexical-binding enabled:

```elisp
;;; filename.el -*- lexical-binding: t; -*-
```

### Documentation

- All custom functions require docstrings
- Use `;;;###autoload` for functions that should be autoloaded
- Comments should explain "why", not "what"

## Key Configuration Details

### NO Evil Mode

This config uses **standard Emacs keybindings** (no Vim emulation). Evil mode is commented out in init.el.

### Completion Framework

- **Corfu** for in-buffer completion (NOT Company)
- **Vertico** for minibuffer completion (NOT Ivy/Helm)
- **Orderless** completion style

### Custom Keybinding Prefixes

| Prefix | Purpose | Examples |
|--------|---------|----------|
| `SPC z` | Org-roam commands | `SPC z f` find node, `SPC z i` insert |
| `SPC b` | Prelude/crux utilities | `SPC b c` cleanup, `SPC b d` duplicate |
| `SPC n a` | Custom agenda | Opens org-super-agenda overview |

### LSP Configuration

- Uses `lsp-mode` with tree-sitter for all supported languages
- Format on save enabled: `(format +lsp +onsave)`
- Tree-sitter font lock level: 4 (maximum coloring)

Language-specific servers:
- **Nix**: `nixd` with flake expressions pointing to `~/.dotfiles`
- **C/C++**: `clangd` with background indexing and clang-tidy
- **Python/Go/Rust/TypeScript**: Standard LSP servers

### Authentication

API keys are stored in `~/.authinfo.gpg` (GPG encrypted):

```elisp
;; Use the helper function to retrieve keys
(bmg/api-key-from-auth-source "api.github.com" "username^service")
```

Format in `.authinfo.gpg`:
```
machine api.github.com login username^service password YOUR_TOKEN
machine api.githubcopilot.com login username password YOUR_KEY
```

## Directory Structure

```
~/Documents/org/           # Main org directory
├── roam/                  # Org-roam notes (Zettelkasten)
│   └── inbox-<hostname>.org  # Capture inbox
├── emacs_lit.bib          # Bibliography file
└── elfeed.score           # Elfeed scoring rules

~/Documents/Papers/        # PDF library for citar

~/projects/                # Project directories (depth 6 for projectile)
└── code/                  # my-repo-pins code root
    └── github.com/        # GitHub repos organized by org/repo

~/.dotfiles/               # NixOS configuration flake
                           # Used by nixd for option completion
```

## Enabled Doom Modules

Key modules from `init.el`:

### Completion
- `corfu` (+orderless +icons +dabbrev)
- `vertico` (+icons)

### Editor
- `format` (+lsp +onsave) - Auto-format on save
- `snippets` - yasnippet
- `fold` - Code folding
- `word-wrap`

### Languages (all with +lsp +tree-sitter)
- `cc`, `go`, `python`, `rust`, `nix`, `javascript`, `json`, `yaml`, `sh`, `markdown`, `latex`
- `org` (+pandoc +pretty +present +roam +noter)
- `emacs-lisp`

### Tools
- `lsp` (+peek)
- `magit` (+forge)
- `tree-sitter`
- `llm` - Language model interface
- `biblio` - Bibliography tools
- `pdf` - PDF viewing

### UI
- `doom`, `doom-dashboard`
- `modeline`, `workspaces`
- `zen` - Distraction-free mode

### Config
- `literate` - Tangle config.org to config.el
- `default` (+bindings +smartparens)

## LLM Integration

### GitHub Copilot CLI (Primary)
- Main LLM interaction tool (external to Emacs)
- Used for chat, code editing, exploration

### copilot.el (Inline Completions)
- Inline code completions in `prog-mode`
- Accept with `TAB`, word-by-word with `C-TAB`

### gptel (Doom Module)
- Provided by Doom's `:tools llm` module
- `gptel-magit` auto-enabled for AI commit messages
- Keybindings under `SPC o l`

## Org-mode Configuration

### Org-roam

- Directory: `~/Documents/org/roam/`
- File template: `${slug}.org`
- Capture templates: "d" (default), "r" (reference)

### Org-super-agenda

Custom agenda command "o" (Overview) groups tasks by:
- Today/Scheduled
- To Refile, Next, Ongoing
- Priority, Due dates
- Projects, Research, Training
- Personal, Reading, Someday

### Tags

Defined tag groups:
- Context: `@Project`, `@Reading`, `@Someday`, `@Training`, `@Courses`, `@Research`, `@Issue`
- Personal: `PERSONAL`
- Special: `Important`, `Emacs`, `uni`

### org-mem

Used for fast agenda file discovery - only includes files with active TODOs/timestamps.

## Testing Configuration Changes

1. **Edit `config.org`** (not config.el directly)
2. **Run `doom sync`** to tangle and rebuild
3. **Restart Emacs** or use `M-x doom/reload`
4. **Check for errors**: `M-x doom doctor` or check `*Messages*` buffer
5. **Test incrementally**: Use `M-x eval-region` or `M-x eval-buffer`

## Common Tasks

### Adding a New Package

1. Add to `packages.el`:
   ```elisp
   (package! new-package)
   ```
2. Configure in `config.org`:
   ```elisp
   (use-package new-package
     :config
     ...)
   ```
3. Run `doom sync`

### Adding a Keybinding

```elisp
(map! :leader
      :desc "Description" "key" #'command)

;; Or in a mode-specific map
(map! :map some-mode-map
      "key" #'command)
```

### Adding a New Language

1. Enable module in `init.el`:
   ```elisp
   (new-lang +lsp +tree-sitter)
   ```
2. Run `doom sync`
3. Install language server (usually via Nix or system package manager)
4. Configure in `config.org` if needed

## Theme and Appearance

- **Theme**: `doom-dracula`
- **Font**: FiraCode Nerd Font Mono (size 13)
- **Variable pitch**: Fira Sans
- **Big font mode**: FiraCode size 19 (for presentations)
- **Symbols**: Font Awesome 7 Free
- **Line numbers**: Enabled (absolute)
- **Cursor**: Non-blinking

## Notes for AI Assistants

When modifying this configuration:

1. **⚠️ EDIT `config.org` ONLY** - This is a literate config; `config.el` is auto-generated and will be overwritten
2. **Always use Doom macros** (`setq!`, `map!`) and standard Emacs (`with-eval-after-load`, `use-package`)
3. **Use `bmg/` prefix** for new custom functions
4. **Wrap package config** in `with-eval-after-load` blocks
5. **Test with `doom doctor`** before considering complete
6. **Preserve section markers** (BEGIN_/END_) for organization
7. **Preserve org-mode structure** - Keep `#+begin_src emacs-lisp` blocks intact
8. **Maintain lexical-binding** headers in standalone `.el` files
9. **Document functions** with docstrings
10. **Follow existing patterns** in the codebase
